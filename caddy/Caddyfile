{
        # Global: Tell Caddy to ask the internal check endpoint before issuing certs
        on_demand_tls {
                ask http://localhost:5555/check
        }
}

# 1. Internal Auth Server (Validates subdomains)
http://localhost:5555 {
        handle /check {
                # Check if the domain ends with .strct.org
                @valid expression {query.domain}.endsWith(".strct.org")
                respond @valid 200
                respond 403
        }
}

dev.strct.org, www.dev.strct.org, dev.portal.strct.org {
        tls {
                on_demand
        }
        reverse_proxy localhost:3001
}

dev.api.strct.org {
        tls {
                on_demand
        }
        reverse_proxy localhost:4001
}

strct.org, www.strct.org, portal.strct.org {
        reverse_proxy localhost:3000
}

api.strct.org {
        reverse_proxy localhost:4000
}

dl.strct.org {
        reverse_proxy localhost:8084
}

# 4. Device Tunnels -> FRP Server (Wildcard Catch-all)
*.strct.org {
        tls {
                on_demand
        }

        reverse_proxy localhost:8080 {
                header_up Host {host}
                header_up X-Real-IP {remote}
        }
}

